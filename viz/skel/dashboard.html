<!doctype html>
<html xmlns:ng=http://angularjs.org>
  <head>
    <meta charset=utf-8 />
    <meta http-equiv=X-UA-Compatible content=IE=edge,chrome=1>
    <meta name=viewport content="width=device-width, initial-scale=1.0">
    <title>Lantern Dashboard</title>
    <link rel=stylesheet href=assets/css/style.css />
    <script src=assets/js/libs/jquery-1.7.1.min.js></script>
    <script src=jquery/json2.js></script>
    <script src=org/cometd.js></script>
    <script src=jquery/jquery.cometd.js></script>
    <script src=assets/js/libs/angular-0.10.5.min.js ng:autobind></script>
  </head>

  <body ng:controller=LDCtrl ng:show=stateloaded() ng:class="!state.initialSetupComplete && 'welcome' || ''" lang=en>
    <div id=ld-container>
      <div id=welcome-container ng:show=!state.initialSetupComplete>
        <div id=welcome class="slide selected" data-cls=slide>
          <h1>Welcome to Lantern</h1>
          <h4>Internet freedom for everyone.</h4>
          <div class=controls>
            <figure>
     <!-- XXX <a href=#terms><img src=assets/img/arrow-right.png alt=Continue /></a> -->
              <a href=#mode><img src=assets/img/arrow-right.png alt=Continue /></a>
              <figcaption>Continue</figcaption>
            </figure>
          </div>
        </div>
        <!--
        <div id=terms class=slide data-cls=slide>
          <h1>Fine Print</h1>
          <textarea readonly>
English

Software License Agreement for Lantern

Please read this software license agreement ("license") carefully before using the software. By using the software, you are agreeing to be bound by the terms of the license. If you do not agree to the terms of this license, do not install and/or use the software, and if presented with the option to "agree" or "disagree" to the terms, click "disagree". 

1. General.
A. ...
          </textarea>
          <div class=controls>
            <figure>
              <a href=#welcome><img src=assets/img/arrow-left.png alt=Disagree /></a>
              <figcaption>Disagree</figcaption>
            </figure>
            <figure>
              <a href=#mode><img src=assets/img/arrow-right.png alt=Agree /></a>
              <figcaption>Agree</figcaption>
            </figure>
          </div>
        </div>
        -->
        <div id=mode class=slide data-cls=slide>
          <h1>Use Lantern to</h1>
          <ul id=modelist>
            <li><label><input type=radio value={{true}} ng:change=switchmode() ng:model=state.getMode /> Get access through others’ connections</label></li>
            <li><label><input type=radio value={{false}} ng:change=switchmode() ng:model=state.getMode /> Give access to others through my connection</label></li>
          </ul>
          <div class=controls>
            <figure>
          <!--<a href=#terms><img src=assets/img/arrow-left.png alt=Back /></a>-->
              <a href=#welcome><img src=assets/img/arrow-left.png alt=Back /></a>
              <figcaption>Back</figcaption>
            </figure>
            <figure>
              <a href=#signin><img src=assets/img/arrow-right.png alt=Continue /></a>
              <figcaption>Continue</figcaption>
            </figure>
          </div>
        </div>
        <div id=signin class=slide data-cls=slide>
          <h1>Sign into Google</h1>
          <form id=firstsignin-form name=fsform class=signin ng:submit=fs_submit()>
            <ul>
              <li><div class=error>Bad username or password.</div></li>
              <li><input type=text placeholder=email@example.com ng:model=inputemail required autofocus ng:disabled={{!loggedout()}} value="{{state.email || ''}}" /></li>
              <li><input type=password placeholder=password ng:model=inputpassword required ng:disabled={{!loggedout()}} value="{{!loggedout() && '•••••••••••••' || ''}}" /></li>
              <li><label><input type=checkbox ng:model=state.savePassword ng:change=toggle('savePassword') /> Save password</label></li>
            </ul>
            <div class=controls>
              <figure>
                <a href=#mode><img src=assets/img/arrow-left.png alt=Back /></a>
                <figcaption>Back</figcaption>
              </figure>
              <figure>
                <input id=fs-submit type=image ng:src={{fs_submit_src()}} alt=Continue ng:disabled="{{loggedout() && fsform.$invalid}}" />
                <figcaption>Continue</figcaption>
              </figure>
            </div>
          </form>
        </div>
        <div id=trustedpeers class=slide data-cls=slide>
          <h1>Trusted Peers</h1>
          <h4>Choose people you would trust to proxy any unencrypted traffic.</h4>
          <input class=searchpeers type=search ng:model=peerfilterinput placeholder="Search by name or email" results=0 incremental autosave/>
          <ul class=peerlist>
            <li ng:repeat="peer in peers.$filter(peerfilter)">
              <label><input type=checkbox ng:model=peer.trusted ng:change=toggleTrusted(peer) /> {{peer.name || peer.email}}</label>
            </li>
            <li ng:show="!peers.$filter(peerfilter).length">No {{peerfilterinput && 'matching' || 'available'}} contacts</li>
          </ul>
          <label><input type=checkbox ng:model=state.useCloudProxies ng:change=toggle('useCloudProxies') /> Use Lantern cloud proxies when no trusted peers are available</label>
          <div class=controls>
            <figure>
              <a href=#signin><img src=assets/img/arrow-left.png alt=Back /></a>
              <figcaption>Back</figcaption>
            </figure>
            <figure>
              <a href=#setupcomplete><img src=assets/img/arrow-right.png alt=Continue /></a>
              <figcaption>Continue</figcaption>
            </figure>
          </div>
        </div>
        <div id=setupcomplete class=slide data-cls=slide>
          <h1>Finished</h1>
          <h4>Thank you for joining Lantern.</h4>
          <div class=controls>
            <figure>
              <a href="{{state.getMode && '#trustedpeers' || '#signin'}}"><img src=assets/img/arrow-left.png alt=Back /></a>
              <figcaption>Back</figcaption>
            </figure>
            <figure>
              <a ng:click=finishsetup()><img src=assets/img/arrow-right.png alt=Finish /></a>
              <figcaption>Finish</figcaption>
            </figure>
          </div>
        </div>
      </div>
      <div id=dashboard ng:show=state.initialSetupComplete>
        <div id=topbar>
          <span id=topbar-conn ng:class="['iconlabel', state.authenticationStatus, state.getMode && 'get' || 'give']"><span class="iconlabel-icon connlight"></span><span class=iconlabel-label>{{conncaption()}}</span></span>
          <span ng:show=loggedin()>
            <!--
            <span id=topbar-peers class=topbar-stat>{{npeers()}} <ng:pluralize count=npeers() when="{'1': 'peer', 'other': 'peers'}"></ng:pluralize></span>
            -->
            <span id=topbar-rate-up class="topbar-stat rate">{{state.upRate | bytes}}</span>
            <span id=topbar-rate-dn class="topbar-stat rate">{{state.downRate | bytes}}</span>
          </span>
          <a ng:show=state.email id=userlink class="collapsed">{{state.email}}</a>
        </div>
        <div id=usermenu class={{state.authenticationStatus}}>
          <ul>
            <li ng:show=loggedin()><a ng:click=switchmode(true)>{{switchlinktext()}}</a></li>
            <li><a ng:click="showsignin(true)">{{loggedin() && 'Switch user' || 'Sign in'}}</a></li>
            <li ng:show=loggedin()><a ng:click=signout()>Sign out</a></li>
          </ul>
        </div>
        <div id=sidebar>
          <h1>Dashboard</h1>
          <!--
          <input id=search type=search placeholder="Search (TODO)" results=0 incremental autosave/>
          -->
          <nav>
            <ul id=panel-list>
              <li><a href=#status class=selected>Status</a></li>
              <li><a href=#hood>Under the Hood</a></li>
              <li><a href=#contact>Contact</a></li>
              <li><a href=#update ng:show="state.update" id="sidebar-update-link">Update</a></li>
            </ul>
          </nav>
        </div>
        <div class="panel selected" id=status data-cls=panel>
          <h1>Status</h1>
          <dl>
            <dt>Mode</dt>
            <dd>
              <span ng:class="['iconlabel', state.authenticationStatus, state.getMode && 'get' || 'give']"><span class="iconlabel-icon connlight"></span><span class=iconlabel-label>{{conncaption()}}
              <a class=actionlink ng:click="!(state.savePassword && state.passwordSaved) && showsignin(true) || signin()" ng:show=loggedout()>Sign in</a></span>
              </span>
            </dd>
            <!--
            <dt ng:show=loggedin()>Peers</dt>
            <dd ng:show=loggedin()>
              <span id=give-mode-peers>
                {{npeers()}}
              </span>
            </dd>
            -->
            <dt ng:show=loggedin()>Traffic</dt>
            <dd ng:show=loggedin()>
              <span class=rate>{{state.upRate+state.downRate|bytes}}</span><!--via {{npeers()}} <ng:pluralize count=npeers() when="{'1': 'peer', 'other': 'peers'}"></ng:pluralize>-->
            </dd>
            <dt>Version</dt>
            <dd>
              Lantern {{state.version}}
              <a href=#update ng:show="state.update" id=update-avail-link class="actionlink panellink">Update available</a>
            </dd>
          </dl>
        </div>
        <div class=panel id=hood data-cls=panel>
          <h1>Under the Hood</h1>
          <dl>
            <dt>Port</dt>
            <dd>
              <input type=number value={{state.port}} id=port min=1024 max=65535 readonly />
            </dd>
            <dt ng:show=state.getMode>Policy</dt>
            <dd ng:show=state.getMode>
              <ul>
                <li>
                  <label>
                    <input type=radio value={{true}} ng:change=toggle('proxyAllSites') ng:model=state.proxyAllSites />
                    Proxy all sites
                  </label>
                </li>
                <li>
                  <label>
                    <input type=radio value={{false}} ng:change=toggle('proxyAllSites') ng:model=state.proxyAllSites />
                    Only proxy certain sites
                  </label>
                  <a class="overlaylink actionlink" ng:show=!state.proxyAllSites href=#proxiedsites>Manage proxied sites...</a>
                </li>
                <li>
                  <a class="overlaylink actionlink" id=manage-trusted-link href=#trustedpeers-overlay>Manage trusted peers...</a>
                </li>
              </ul>
            </dd>
            <dt>Application</dt>
            <dd>
              <ul>
                <li><label><input type=checkbox ng:change=toggle('startAtLogin') ng:model=state.startAtLogin /> Launch on system startup</label></li>
                <li><label><input type=checkbox ng:change=toggle('connectOnLaunch') ng:model=state.connectOnLaunch /> Sign in on launch</label></li>
                <li><label><input type=checkbox ng:change=toggle('systemProxy') ng:model=state.systemProxy /> Set as system proxy</label></li>
              </ul>
              <input type=button id=reset-button ng:click=reset() value="Reset Lantern" />
            </dd>
          </dl>
        </div>
        <div class=panel id=contact data-cls=panel>
          <h1>Contact</h1>
          <p>
            Topics suitable for public access should be directed to the
            <a href="https://groups.google.com/forum/#!forum/lantern-users-en"
            target=_blank>Lantern users forum</a>.
          </p>
          <textarea ng:model=pm id=pm-textarea placeholder="Private message to Lantern developers"></textarea>
          <div id=pm-controls>
            <!--
            <label><input type=checkbox ng:model=requestreply /> please reply to</label>
            <input id=pm-replyto type=email ng:model=requestreplyto ng:disabled={{!requestreply}} placeholder=email@example.com value={{state.email}} />
            -->
            <input id=pm-send type=button value=Send ng:disabled="{{!loggedin() || !pm}}" ng:click=sendpm() />
          </div>
          <div class=extra ng:show=requestreply>
            Only request replies to secure email accounts.
          </div>
        </div>
        <div class=panel id=update data-cls=panel>
          <h1>Update</h1>
        </div>

        <div id=signin-overlay ng:show=showsignin()>
          <a class=close ng:click="showsignin(false)">×</a>
          <form name=signinform class=signin ng:submit=signin(inputemail)>
            <ul>
              <li><div class=error>Bad username or password.</div></li>
              <li><input type=text placeholder=email@example.com ng:model=inputemail autofocus value="{{state.email || ''}}" required /></li>
              <li><input type=password placeholder=password ng:model=inputpassword ng:required="{{!((inputemail == state.email || inputemail + '@gmail.com' == state.email) && state.passwordSaved && state.savePassword)}}" /></li>
              <li><label><input type=checkbox ng:model=state.savePassword ng:change=toggle('savePassword') /> Save password</label></li>
            </ul>
            <button ng:show=!loggingin() type=submit ng:disabled="{{(inputemail == null || inputemail == state.email || inputemail + '@gmail.com' == state.email) && loggedin()}}" >Sign in</button>
            <img src=assets/img/spinner32.gif alt="Logging in..." ng:show=loggingin() />
          </form>
        </div>

        <div class=overlay id=proxiedsites data-cls=overlay>
          <a class=close>×</a>
          <h1>Proxied sites</h1>
          <ul id=siteslist>
            <li ng:repeat="entry in whitelist.$orderBy('required')">
              <form ng:submit="!entry.required && updatewhitelist(entry.site, newsite)"><input class=whitelistentry ng:model=newsite type=text placeholder=example.com value="{{entry.site + (entry.required && ' (required)' || '')}}" required ng:readonly={{entry.required}} ng:pattern=/^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}$/ /></form>
              <a class=delete ng:show=!entry.required ng:click="updatewhitelist(entry.site, false)">×</a>
            </li>
            <li>
              <form ng:submit="updatewhitelist(sitetoadd, true)"><input id=sitetoadd ng:model=sitetoadd type=text required placeholder="Add a new site" /></form>
            </li>
          </ul>
        </div>

        <div class=overlay data-cls=overlay id=trustedpeers-overlay>
          <a class=close>×</a>
          <h1>Trusted peers</h1>
          <input class=searchpeers type=search ng:model=peerfilterinput placeholder="Search by name or email" results=0 incremental autosave/>
          <ul class=peerlist>
            <li ng:repeat="peer in peers.$filter(peerfilter)">
              <label><input type=checkbox ng:model=peer.trusted ng:change=toggleTrusted(peer) /> {{peer.name || peer.email}}</label>
            </li>
            <li ng:show="!peers.$filter(peerfilter).length">No {{peerfilterinput && 'matching' || 'available'}} contacts</li>
          </ul>
          <label class=usecloud><input type=checkbox ng:model=state.useCloudProxies ng:change=toggle('useCloudProxies') /> Use Lantern cloud proxies when no trusted peers are available</label>
        </div>

      </div>
    </div>

<script>
cometd = $.cometd;

FETCHING = 'fetching...'; // poor-man's promise
FETCHFAILED = 'fetch failed';

// http://html5pattern.com/
HOSTNAMEPAT = /^([a-zA-Z0-9]([a-zA-Z0-9\-]{0,61}[a-zA-Z0-9])?\.)+[a-zA-Z]{2,6}$/;

BYTEDIM = {GB: 1024*1024*1024, MB: 1024*1024, KB: 1024};
angular.filter('bytes', function(input) {
  var nbytes = parseInt(input);
  if(isNaN(nbytes))return input;
  for(dim in BYTEDIM){
    var base = BYTEDIM[dim];
    if(nbytes >= base){
      return Math.round(nbytes/base) + dim;
    }
  }
  return nbytes + 'B';
});

FRAGMENTPAT = /^[^#]*(#.*)$/;
function clickevt2id(evt){
  //console.log('evt.target:',evt.target,'evt.currentTarget:',evt.currentTarget);
  return evt.currentTarget.href.match(FRAGMENTPAT)[1];
}
function showid(id, ignorecls){
  var $el = $(id);
  if(!$el.length)
    return;
  location.hash = id;
  if($el.hasClass('selected'))
    return;
  var cls = $el.attr('data-cls');
  if(cls === ignorecls)
    return;
  $('.' + cls + '.selected').toggleClass('selected');
  $el.toggleClass('selected');
  if(cls === 'panel'){
    $('#panel-list > li > a.selected').toggleClass('selected');
    $('#panel-list > li > a[href='+id+']').toggleClass('selected');
  }
}
function showidclickhandler(evt){
  showid(clickevt2id(evt));
  var docheight = $(document).height(), bodheight = $('body').height();
  if(docheight > bodheight){ // XXX height hack
    console.log('height hack: increasing body height from', bodheight, 'to', docheight);
    $('body').height(docheight);
  }
}

function LDCtrl(){
  var self = this;
  self.state = {};
  self.stateloaded = function(){
    return !$.isEmptyObject(self.state);
  };
  self.$watch('state');
  self.update = function(state){
    self.state = state;
    self.$digest();
  };

  self.inputemail = null;
  self.inputpassword = null;

  self.peerfilterinput = null;
  self.peerfilter = function(peer){
    var f = self.peerfilterinput;
    if(!f)return true;
    if(peer.name && peer.name.indexOf(f) !== -1)return true;
    return peer.email.indexOf(f) !== -1;
  };
  self.peers = null;
  self.whitelist = null;

  self.showsignin = function(val){
    if(typeof val == 'undefined'){
      if(typeof self._showsignin == 'undefined'){
        self._showsignin = !self.loggedin() && self.state.connectOnLaunch && !self.state.passwordSaved;
        console.log('set _showsignin to', self._showsignin);
      }
    }else{
      self._showsignin = val;
    }
    return self._showsignin;
  }

  self.pm = null;
  self.requestreply = false;
  self.requestreplyto = null;

  self.loggedin = function(){return self.state.authenticationStatus === 'LOGGED_IN';};
  self.loggedout = function(){return self.state.authenticationStatus === 'LOGGED_OUT';};
  self.loggingin = function(){return self.state.authenticationStatus === 'LOGGING_IN';};

  self.conncaption = function(){
    switch(self.state.authenticationStatus){
    case 'LOGGED_OUT':
      return 'Not connected';
    case 'LOGGING_IN':
      return 'Connecting';
    case 'LOGGING_OUT':
      return 'Disconnecting';
    case 'LOGGED_IN':
      return (self.state.getMode?'Gett':'Giv')+'ing access';
    }
  };

  self.switchlinktext = function(){
    if(self.loggedin())
      return 'Switch to '+(self.state.getMode?'giv':'gett')+'ing access';
  };

  self.fs_submit = function(){
    if(self.loggedout()){
      console.log('calling signin');
      self.signin(self.inputemail);
    }else{
      console.log('already signed in, just skipping to next screen');
      showid(self.state.getMode && '#trustedpeers' || '#setupcomplete');
    }
  };

  self.fetchpeers = function(){
    if(self.state.getMode){
      console.log('fetching peers');
      self.peers = FETCHING;
      $.ajax({url: '/api/roster', dataType: 'json'}).done(function(r){
        self.peers = r.entries;
        console.log('set peers');
      }).fail(function(e){
        console.log('failed to fetch peers:',e);
        self.peers = FETCHFAILED;
      });
    }
  };

  self.fetchwhitelist = function(){
    if(self.state.getMode){
      console.log('fetching whitelist');
      self.whitelist = FETCHING;
      $.ajax({url: '/api/whitelist', dataType: 'json'}).done(function(r){
        self.whitelist = r.entries;
        console.log('set whitelist');
      }).fail(function(e){
        console.log('failed to fetch whitelist:',e);
        self.whitelist = FETCHFAILED;
      });
    }
  };

  self.signin = function(email){
    if(self.loggedin()){
      if(email === null || email === self.state.email || email + '@gmail.com' === self.state.email){
        console.log('ingoring signin as', self.state.email, 'already signed in as that user');
        self.showsignin(false);
        self.inputpassword = '';
        return;
      }
    }
    var data = {
      email: email || self.state.email
    };
    if(!self.state.savePassword || !self.state.passwordSaved){
      data.password = self.inputpassword;
      if(!data.password){
        console.log('no password saved or supplied, bailing');
        self.inputpassword = '';
        return;
      }
    }
    console.log('Signing in with:', data);
    $.post('/api/signin', data).done(function(){
      console.log('signin succeeded');
      $('form.signin').removeClass('badcredentials');
      self.inputpassword = '';
      self.showsignin(false);
      self.fetchpeers();
      if(!self.state.initialSetupComplete)
        showid(self.state.getMode && '#trustedpeers' || '#setupcomplete');
    }).fail(function(){
      $('form.signin').addClass('badcredentials');
      console.log('signin failed');
    });
  };

  self.fs_submit_src = function(){
    if(self.fsform.$invalid) // XXX sometimes this lies
      return 'assets/img/arrow-right-disabled.png';
    if(self.loggingin())
      return 'assets/img/spinner32.gif';
    return 'assets/img/arrow-right.png';
  };

  self.toggleTrusted = function(peer){
    var url = '/api/' + (peer.trusted ? 'add' : 'remove') + 'trustedpeer?email=' + peer.email;
    $.post(url).done(function(){
      console.log('successfully set peer.trusted to ' + peer.trusted + ' for ' + peer.email); 
    }).fail(function(){
      peer.trusted = !peer.trusted;
      console.log('failed to set peer.trusted to ' + peer.trusted + ' for ' + peer.email); 
    });
  }

  self.finishsetup = function(){
    showid('#setupcomplete');
    $('#welcome-container').fadeOut('slow');
    setTimeout(function(){
    $.post('/settings?initialSetupComplete=true').done(function(){
      self.showsignin(false)
      showid('#status');
    }).fail(function(e){
      alert('Could not complete setup.'); console.log(e); // XXX
    });
    }, 1000);
  };

  self.signout = function(){
    $.post('/api/signout');
  };

  self.toggle = function(setting, manual){
    if(manual)
      self.state[setting] = !self.state[setting];
    $.post('/settings?'+setting+'='+self.state[setting]).done(function(){
      console.log('successfully toggled '+setting+' to '+self.state[setting]);
    }).fail(function(){
      console.log('failed to toggle '+setting);
    });
  };

  self.switchmode = function(manual){
    var proceed = true;
    if(self.state.getMode && self.state.countryDetected.censoring)
      proceed = confirm('It looks like you may be in a censoring country. ' +
        'Only run Lantern in “give access” mode if you believe your ' +
        'connection to be private and properly secured.');
    proceed && self.toggle('getMode', manual);
  };

  self.reset = function(){
    var msg = 'Are you sure you want to reset Lantern? ' +
      (self.loggedin() ? 'You will be signed out and y' : 'Y') +
      'our settings will be erased.';
    if(confirm(msg)){
      $.post('/api/reset').done(function(){
        showid('#welcome');
      });
    }
  };

  self._validatewhitelistentry = function(val){
    // XXX ip addresses acceptable?
    if(!HOSTNAMEPAT.test(val)){
      console.log('not a valid hostname:', val, '(so much for html5 defenses)');
      return false;
    }
    return true;
  };

  self.updatewhitelist = function(site, newsite){
    if(typeof newsite === 'string'){
      if(!self._validatewhitelistentry(newsite))return;
      if(newsite === site){
        console.log('site == newsite == ', site, 'ignoring');
        return;
      }
      $.ajax('/api/removefromwhitelist?site=' + site).done(function(){
        $.ajax('/api/addtowhitelist?site=' + newsite).done(function(){
          self.fetchwhitelist();
        }).fail(function(){
          console.log('/api/addtowhitelist?site='+site+' failed');
        });
        self.fetchwhitelist();
      }).fail(function(){
        console.log('/api/removefromwhitelist?site='+site+' failed');
      });
    }else if(typeof newsite === 'boolean'){
      if(!self._validatewhitelistentry(site))return;
      var url = '/api/' + (newsite ? 'addtowhitelist' : 'removefromwhitelist') + '?site=' + site;
      $.ajax(url).done(function(){
        if(newsite)
          $('#sitetoadd').val('');
        self.fetchwhitelist();
      }).fail(function(){
        console.log(url+' failed');
      });
    }
  };

  self.sendpm = function(){
    if(!self.pm)return;
    var data = {
      message: self.pm
    };
    console.log('submitting contact form, data=', data);
    $.post('/api/contact', data).done(function(){
      console.log('contact form submitted successfully');
      // XXX TODO flash success message
      self.pm = '';
    }).fail(function(e){
      // XXX TODO flash failure message
      console.log('failed to submit contact form', e);
    });
  };

  self.todo = function(){alert('todo');}
}

$(document).ready(function(){
  var scope = null;
  var $body = $('body');

  $(window).bind('hashchange', function(){
    showid(location.hash);
  });
  $('#panel-list a, ' +
    '.panellink, ' +
    '#welcome-container .controls a[href], ' +
    '.overlaylink'
    ).click(showidclickhandler);

  // XXX height hack
  $window = $(window);
  function _resize_body(){
    $body.height($window.height());
  }
  $window.resize(_resize_body);

  $('.overlay .close').click(function(evt){
    $(evt.target).parent('.overlay').removeClass('selected');
    evt.preventDefault();
    _resize_body(); // XXX height hack
  });

  $('#userlink, #usermenu a').click(function(evt){
    $('#usermenu').slideToggle(50);
    $('#userlink').toggleClass('collapsed');
  });

  // XXX
  $('input.whitelistentry').live('blur', function(){
    console.log('blur');
    if(!scope)
      scope = $body.scope();
    scope.fetchwhitelist();
  });

  function _connectionEstablished(){
    console.log('CometD Connection Established');
  }

  function _connectionBroken(){
    console.log('CometD Connection Broken');
    // XXX "Closing window in x seconds..."?
  }

  // XXX never getting called?
  function _connectionClosed(){
    console.log('CometD Connection Closed');
    alert('CometD Connection Closed');
    // XXX "Lantern has shut down." Close window
  }

  // Function that manages the connection status with the Bayeux server
  var _connected = false;
  function _metaConnect(message){
    if (cometd.isDisconnected()){
      _connected = false;
      _connectionClosed();
      return;
    }

    var wasConnected = _connected;
    _connected = message.successful === true;
    if (!wasConnected && _connected){
      _connectionEstablished();
    }else if(wasConnected && !_connected){
      _connectionBroken();
    }
  }

  function syncHandler(msg){
    if(!scope)
      scope = $body.scope();
    scope.update(msg.data);

    // XXX
    if(scope.state.getMode){
      if(scope.loggedin()){
        if(scope.peers === FETCHFAILED){
          // XXX back-off
          console.log('retrying fetchpeers in 1s');
          setTimeout(scope.fetchpeers, 1000);
        }else if(scope.peers === null){
          console.log('calling fetch peers for the first time');
          scope.fetchpeers();
        }
      }
      if(scope.whitelist === null){
        scope.fetchwhitelist();
      }else if(scope.whitelist === FETCHFAILED){
        // XXX back-off
        console.log('retrying fetchwhitelist in 1s');
        setTimeout(scope.fetchwhitelist, 1000);
      }
    }
  }

  function _metaHandshake(handshake){
    if (handshake.successful === true){
      cometd.batch(function(){
        cometd.subscribe('/sync', syncHandler);
        if(location.hash)
          showid(location.hash, 'overlay');
      });
    }
  }

  $(window).unload(function(){
    cometd.disconnect(true);
  });

  var cometURL = location.protocol + "//" + location.host + "/cometd";
  cometd.configure({
    url: cometURL,
    logLevel: 'info'
  });

  cometd.addListener('/meta/handshake', _metaHandshake);
  cometd.addListener('/meta/connect', _metaConnect);

  cometd.handshake();
});
</script>

  </body>
</html>