<!doctype html>
<html xmlns:ng=http://angularjs.org>
  <head>
    <meta charset=utf-8 />
    <meta http-equiv=X-UA-Compatible content=IE=edge,chrome=1>
    <meta name=viewport content="width=device-width, initial-scale=1.0">
    <title>Lantern Dashboard</title>
    <link rel="shortcut icon" href=assets/img/favicon.png>
    <link rel=stylesheet href=assets/css/style.css />
<!--<link rel=stylesheet href=assets/css/chosen.css />-->

    <!-- XXX jquery tools includes jquery 1.6.4 -->
<!--<script src=assets/js/libs/jquery.1.7.1.min.js></script>-->
<!--<script src=http://cdn.jquerytools.org/1.2.6/jquery.tools.min.js></script>-->
    <script src=assets/js/libs/jquery.tools.min.js></script>
<!--<script src=assets/js/libs/chosen.jquery.min.js></script>-->

    <script src="jquery/json2.js"></script>
    <script src="org/cometd.js"></script>
    <script src="jquery/jquery.cometd.js"></script>

<!--<script src=http://code.angularjs.org/0.10.5/angular-0.9.15.min.js ng:autobind></script>-->
    <script src=assets/js/libs/angular-0.10.5.min.js ng:autobind></script>
  </head>

  <body ng:controller=LDCtrl ng:class="showwelcome() && 'welcome'" lang="en">
    <div id=ld-container>
      <div id=welcome-container ng:show=showwelcome()>
        <div id=welcome class="slide selected" data-cls=slide>
          <h1>Welcome to Lantern</h1>
          <h4>Internet freedom for everyone.</h4>
          <div class=controls>
            <a href=#agree>➲</a>
            <div>Continue</div>
          </div>
        </div>
        <div id=agree class=slide data-cls=slide>
          <p>Maybe you have to agree to some terms of use here.</p>
          <div class=controls>
            <a href=#mode>➲</a>
            <div>Continue</div>
          </div>
        </div>
        <div id=mode class=slide data-cls=slide>
          <p>Confirm inferred mode here.</p>
          <p>Mode: {{state.getMode && 'get' || 'give'}}</p>
          <div class=controls>
            <a href=#firstsignin>➲</a>
            <div>Continue</div>
          </div>
        </div>
        <div id=firstsignin class=slide data-cls=slide>
          <p>Sign into Google to continue.</p>
          <ng:include src="'assets/partials/signin.html'"></ng:include>
          <div class=controls>
            <a id=firstsignin-link>➲</a>
            <div>Continue</div>
          </div>
        </div>
      </div>
      <div id=dashboard ng:show=!showwelcome()>
        <div id=topbar>
          <span id=topbar-conn ng:class="['iconlabel', state.authenticationStatus, state.getMode && 'GET' || 'GIVE']"><span class="iconlabel-icon connlight"></span><span class=iconlabel-label>{{conncaption()}}</span></span>
          <span ng:show=connected()>
            <span id=topbar-peers class=topbar-stat>{{npeers()}} <ng:pluralize count=npeers() when="{'1': 'peer', 'other': 'peers'}"></ng:pluralize></span>
            <span id=topbar-rate-up class="topbar-stat rate">{{state.upRate | bytes}}</span>
            <span id=topbar-rate-dn class="topbar-stat rate">{{state.downRate | bytes}}</span>
          </span>
          <a ng:show=state.email id=userlink class="collapsed">{{state.email}}</a>
        </div>
        <div id=usermenu>
          <ul>
            <li><a ng:click=todo()>Switch user</a></li>
            <li ng:show=connected()><a ng:click=signout()>Sign out</a></li>
            <li ng:show=!connected()><a ng:click=signin()>Sign in</a></li>
          </ul>
        </div>
        <div id=sidebar>
          <h1>Dashboard</h1>
          <!-- XXX <input id=search type=search placeholder=Search results=5 incremental autosave/> -->
          <nav>
            <ul id=panel-list>
              <li><a href=#status class=selected>Status</a></li>
              <li><a href=#hood>Under the Hood</a></li>
              <li><a href=#contact>Contact</a></li>
              <li><a href=#update ng:show="state.update" id="sidebar-update-link">Update</a></li>
            </ul>
          </nav>
        </div>
        <div class="panel selected" id=status data-cls=panel>
          <h1>Status</h1>
          <dl>
            <dt>Mode</dt>
            <dd>
              <span ng:class="['iconlabel', state.authenticationStatus, state.getMode && 'GET' || 'GIVE']"><span class="iconlabel-icon connlight"></span><span class=iconlabel-label>{{conncaption()}}<a class="actionlink" id="switch-mode-link" ng:click="switchmode()">{{switchlinktext()}}</a></span></span>
            </dd>
            <dt ng:show=connected()>Peers</dt>
            <dd ng:show=connected()>
              <span id=give-mode-peers>
                {{npeers()}}
              </span>
            </dd>
            <dt ng:show=connected()>Traffic</dt>
            <dd ng:show=connected()>
              {{state.upRate+state.downRate|bytes}}/s via {{npeers()}} <ng:pluralize count=npeers() when="{'1': 'peer', 'other': 'peers'}"></ng:pluralize>
            </dd>
            <dt>Version</dt>
            <dd>
              Lantern {{state.version}}
              <a href=#update ng:show="state.update" id=update-avail-link class="actionlink panellink">Update available</a>
            </dd>
          </dl>
        </div>
        <div class=panel id=hood data-cls=panel>
          <h1>Under the Hood</h1>
          <dl>
            <dt>Port</dt>
            <dd>
              <input type=number value={{state.port}} id=port min=1024 max=65535 disabled />
            </dd>
            <dt ng:show=state.getMode>Policy</dt>
            <dd ng:show=state.getMode>
              <ul>
                <li><label><input type=radio value={{true}} ng:change=toggle('proxyAllSites') ng:model=state.proxyAllSites /> Proxy all sites</label></li>
                <li><label><input type=radio value={{false}} ng:change=toggle('proxyAllSites') ng:model=state.proxyAllSites /> Only proxy certain sites</label></li>
                <li><input type=button ng:disabled={{state.proxyAllSites}} ng:click=toggleproxiedsites(true) value="Manage proxied sites..." /></li>
              </ul>
            </dd>
            <dt>Application</dt>
            <dd>
              <ul>
                <li><label><input type=checkbox ng:change=toggle('startAtLogin') ng:model=state.startAtLogin /> Launch on system startup</label></li>
                <li><label><input type=checkbox ng:change=toggle('connectOnLaunch') ng:model=state.connectOnLaunch /> Sign in on launch</label></li>
                <li><label><input type=checkbox ng:change=toggle('systemProxy') ng:model=state.systemProxy /> Set as system proxy</label></li>
              </ul>
              <input type=button ng:click=reset() id=reset-button value="Reset Lantern" />
            </dd>
          </dl>
          <div class=overlay id=manageproxiedsites>
            <a class=close ng:click=toggleproxiedsites(false)>×</a>
            <h1>Proxied sites</h1>
            <div id=sitestablecontainer>
            <table>
              <tr ng:repeat="entry in state.whitelist.entries">
                <td><form ng:submit="!entry.required && updatewhitelist(entry.site, newsite)"><input ng:model=newsite type=text required placeholder=example.com value="{{ entry.site }}" ng:disabled={{entry.required}} /></form></td>
                <td class=x><a ng:show=!entry.required ng:click="updatewhitelist(entry.site, false)">×</a></td>
              </tr>
              <tr>
                <td colspan=2><form ng:submit="updatewhitelist(sitetoadd, true)"><input id=sitetoadd ng:model=sitetoadd type=text required placeholder="Add a new site" /></form></td>
              </tr>
            </table>
            </div>
          </div>
        </div>
        <div class=panel id=contact data-cls=panel>
          <h1>Contact</h1>
          <p>
            Topics suitable for public access should be directed to the
            <a href="https://groups.google.com/forum/#!forum/lantern-users-en"
            target=_blank>Lantern users forum</a>.
          </p>
          <textarea ng:model=pm id=pm-textarea placeholder="Private message to Lantern developers"></textarea>
          <div id=pm-controls>
            <label><input type=checkbox ng:model=requestreply /> please reply to</label>
            <input id=pm-replyto type=email ng:model=requestreplyto ng:disabled={{!requestreply}} placeholder=email@example.com value={{state.email}} />
            <input id=pm-send type=button value=Send ng:disabled="{{!connected() || !pm}}" ng:click=todo() />
          </div>
          <div ng:class="['extra', !requestreply && 'disabled']">
            Only request replies to secure email accounts.
          </div>
        </div>
        <div class=panel id=update data-cls=panel>
          <h1>Update</h1>
        </div>
      </div>
    </div>


<script>
cometd = $.cometd;

BYTEDIM = {GB: 1024*1024*1024, MB: 1024*1024, KB: 1024};
angular.filter('bytes', function(input) {
  var nbytes = parseInt(input);
  if(isNaN(nbytes))return input;
  for(dim in BYTEDIM){
    var base = BYTEDIM[dim];
    if(nbytes >= base){
      return Math.round(nbytes/base) + dim;
    }
  }
  return nbytes + 'B';
});

function LDCtrl(){
  var self = this;
  self.state = {};
  self.$watch('state');
  self.update = function(state){
    self.state = state;
    self.$digest();
  };

  self.connected = function(){return self.state.authenticationStatus === 'LOGGED_IN';};
  self.npeers = function(){return 0;}; // XXX

  self.conncaption = function(){
    switch(self.state.authenticationStatus){
    case 'LOGGED_OUT':
      return 'Not connected';
    case 'LOGGING_IN':
      return 'Connecting';
    case 'LOGGING_OUT':
      return 'Disconnecting';
    case 'LOGGED_IN':
      return (self.state.getMode?'Gett':'Giv')+'ing access';
    }
  };

  self.switchlinktext = function(){
    if(self.connected())
      return 'Switch to '+(self.state.getMode?'giv':'gett')+'ing access';
  };

  self.signin = function(){
    /*
    // XXX
    if(!self.state.email || !self.state.savePassword){
      // XXX display signin form
    }
    var data = {
      email: self.state.email || $('form.signin:visible').find('input[name=email]').val(),
      password: self.state.savePassword || $('form.signin:visible').find('input[name=password]').val()
    };
    try{
      var storepassword = $('form.signin:visible').find('input[name=storepassword]').get(0).checked;
      data.storepassword = storepassword;
    }catch(e){}
    */
    var data = {email: self.state.email};
    if(!self.state.savePassword)
      data.password = prompt('Please enter your password:');
    $.when($.post('/api/signin', data)).then(function(data){
      $('form.signin:visible').removeClass('badcredentials');
      location.href = '#status'; // XXX
    }).fail(function(){
      $('form.signin:visible').addClass('badcredentials');
    });
  };

  self.signout = function(){
    $.post('/api/signout');
  };

  self.toggle = function(setting, manual){
    if(manual)
      self.state[setting] = !self.state[setting];
    $.when($.post('/settings?'+setting+'='+self.state[setting]))
     .then(function(){console.log('successfully toggled '+setting+' to '+self.state[setting]);})
     .fail(function(){console.log('failed to toggle '+setting);});
  };

  self.switchmode = function(){
    var proceed = true;
    if(self.state.getMode && self.state.countryDetected.censoring)
      proceed = confirm('It looks like you may be in a censoring country. ' +
        'Only run Lantern in “give access” mode if you believe your ' +
        'connection to be private and properly secured.');
    proceed && self.toggle('getMode', true);
  };

  self.reset = function(){
    var msg = 'Are you sure you want to reset Lantern? ' +
      (self.connected() ? 'You will be signed out and y' : 'Y') +
      'our settings will be erased.';
    if(confirm(msg)){
      $.post('/reset');
      location.href = '#welcome';
    }
  };

  self.showwelcome = function(){
    return !self.state.email;
  };

  self.proxiedsitesoverlay = null;
  self.toggleproxiedsites = function(show){
    if(show){
      if(self.proxiedsitesoverlay){
        self.proxiedsitesoverlay.fadeIn();
      }else{
        self.proxiedsitesoverlay = $('#manageproxiedsites').overlay({closeOnClick:true, load:true});
      }
    }else{
      self.proxiedsitesoverlay.fadeOut();
    }
  };

  self.updatewhitelist = function(site, newsite){
    // XXX validation
    if(typeof newsite === 'string'){
      $.when($.ajax('/api/removefromwhitelist?site=' + site)).then(function(){
      $.when($.ajax('/api/addtowhitelist?site=' + newsite)).then(function(){
        $('#sitetoadd').val('');
      })});
    }else if(typeof newsite === 'boolean'){
      var url = '/api/' + (newsite ? 'addtowhitelist' : 'removefromwhitelist');
      $.when($.ajax(url + '?site=' + site)).then(function(){newsite && $('#sitetoadd').val('');});
    }
  };

  self.pm = null;
  self.requestreply = false;
  self.requestreplyto = null;

  self.todo = function(){alert('todo');}
}

$(document).ready(function(){
  var fragmentpat = /^[^#]*(#.*)$/;
  function showid(id){
    var $el = $(id);
    var cls = $el.attr('data-cls');
    if(!$el.length || $el.hasClass('selected'))return;
    $('.' + cls + '.selected').toggleClass('selected');
    $el.toggleClass('selected');
    if(cls === 'panel'){
      $('#panel-list > li > a.selected').toggleClass('selected');
      $('#panel-list > li > a[href='+id+']').toggleClass('selected');
    }
  }
  $('#panel-list a, .panellink').click(function(evt){
    showid(evt.target.href.match(fragmentpat)[1]);
  });
  $('#welcome-container .controls a[href]').click(function(evt){
    showid(evt.target.href.match(fragmentpat)[1]);
  });
  $('#firstsignin-link').click(function(evt){
    $('#firstsignin button[type=submit]').click(); // XXX
    evt.preventDefault();
  });
  $('#userlink, #usermenu a').click(function(evt){
    $('#usermenu').slideToggle(50);
    $('#userlink').toggleClass('collapsed');
  });


  function _connectionEstablished(){
    console.log('CometD Connection Established');
  }

  function _connectionBroken(){
    console.log('CometD Connection Broken');
    // XXX "Closing window in x seconds..."?
  }

  function _connectionClosed(){
    console.log('CometD Connection Closed');
    alert('CometD Connection Closed');
    // XXX "Lantern has shut down." Close window
  }

  // Function that manages the connection status with the Bayeux server
  var _connected = false;
  function _metaConnect(message){
    if (cometd.isDisconnected()){
      _connected = false;
      _connectionClosed();
      return;
    }

    var wasConnected = _connected;
    _connected = message.successful === true;
    if (!wasConnected && _connected){
      _connectionEstablished();
    }else if(wasConnected && !_connected){
      _connectionBroken();
    }
  }

  function syncHandler(msg){
    $('body').scope().update(msg.data);
    //console.log('update:', msg.data);
  }

  function _metaHandshake(handshake){
    if (handshake.successful === true){
      cometd.batch(function(){
        cometd.subscribe('/sync', syncHandler);
        if(location.hash)
          showid(location.hash);
      });
    }
  }

  $(window).unload(function(){
    cometd.disconnect(true);
  });

  var cometURL = location.protocol + "//" + location.host + "/cometd";
  cometd.configure({
    url: cometURL,
    logLevel: 'info'
  });

  cometd.addListener('/meta/handshake', _metaHandshake);
  cometd.addListener('/meta/connect', _metaConnect);

  cometd.handshake();
});
</script>

  </body>
</html>